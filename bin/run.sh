#!/bin/bash
set -e
set -x


#
# ES_PORT
# 
#
#

VERS="0.0.4"
echo $VERS;

export RAM=${RAM:-512M}
#export JAVA OPTIONS="-Xmx${RAM} -Xmx${RAM} "

export LS_HEAP_SIZE="$RAM"
export LS_NICE=10
export LS_USE_GC_LOGGING=""
export LS_OPEN_FILES=16384
#export LS_LOG_FILE=/var/log/logstash/logstash.log

export ES_HOST=${ES_HOST:-es}

# see if we can talk to ES_HOST
if ping -c 3 ${ES_HOST}
then
	echo "ES_HOST is pingabble"
else
	echo "cannot ping '${ES_HOST}' lets go our sperate ways, bye for now"
	exit 74;
fi

export ES_PORT=${ES_PORT_9200_TCP_PORT:-${ES_PORT:-9200}}

export REDIS_HOST=${REDIS_PORT_6379_TCP_ADDR:-${REDIS_HOST:-}}
export REDIS_PORT=6379


export EMBEDDED="false"
export WORKERS=${ELASTICWORKERS:-1}

export LS_ROOT=${LS_ROOT:-/data/logstash}
export LS_CONFIG=${LS_CONFIG:-${LS_ROOT}/logstash.conf}

if [ "$ES_HOST" = "127.0.0.1" ] ; then
    export EMBEDDED="true"
fi

# name of autogenerated config file
export LS_CONFIG_FILE=${LS_ROOT}/logstash-run.conf

# replace templaet vars
echo "Generating LS config file [merge shell env templates] ${LS_CONFIG_FILE}"
cat $LS_CONFIG | /usr/local/bin/bash-templater.sh > ${LS_CONFIG_FILE}

echo "LS_CONFIG_FILE=${LS_CONFIG_FILE}"

if [ ! -f ${LS_CONFIG_FILE} ]; then
	echo "error, missig confgi file for logstash: '${LS_CONFIG_FILE}'"
	exit 75
fi


echo "---${LS_CONFIG_FILE}---"
cat ${LS_CONFIG_FILE}
echo "---END::${LS_CONFIG_FILE}::---"
ls -l ${LS_ROOT}

ulimit -n ${LS_OPEN_FILES}
/opt/logstash/bin/logstash -f ${LS_CONFIG_FILE} --configtest 

exec nice -n ${LS_NICE} /opt/logstash/bin/logstash agent -f ${LS_CONFIG_FILE}


#exec /opt/logstash/bin/logstash agent -f /opt/logstash-run.conf

